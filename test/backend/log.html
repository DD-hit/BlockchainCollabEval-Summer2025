<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>åŒºå—é“¾è´¦æˆ·ç®¡ç†</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 800px;
    }

    .container {
      display: flex;
      gap: 30px;
    }

    .form-section {
      flex: 1;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      width: 100%;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .login-btn {
      background-color: #28a745;
    }

    .login-btn:hover {
      background-color: #218838;
    }

    .result {
      margin-top: 20px;
      padding: 15px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 5px;
      display: none;
    }

    .success {
      background-color: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }

    .error {
      background-color: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }

    .address,
    .private-key {
      font-family: monospace;
      background-color: #e9ecef;
      padding: 8px;
      margin: 5px 0;
      border-radius: 3px;
      word-break: break-all;
    }

    .warning {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 5px;
      margin: 15px 0;
    }

    .user-info {
      background-color: #e7f3ff;
      border: 1px solid #b3d9ff;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      display: none;
    }

    .logout-btn {
      background-color: #dc3545;
      margin-top: 10px;
    }

    .logout-btn:hover {
      background-color: #c82333;
    }

    .project-btn {
      background-color: #17a2b8;
      margin-bottom: 10px;
    }

    .project-btn:hover {
      background-color: #138496;
    }

    /* å¼¹çª—æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      position: relative;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    .show-private-key {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }

    .show-private-key:hover {
      background-color: #c82333;
    }

    .private-key-hidden {
      color: #6c757d;
      font-style: italic;
    }
  </style>
</head>

<body>
  <h2>ğŸ”— åŒºå—é“¾è´¦æˆ·ç®¡ç†</h2>

  <div class="container">
    <!-- ç™»å½•éƒ¨åˆ† -->
    <div class="form-section">
      <h3>ğŸ” ç”¨æˆ·ç™»å½•</h3>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginUsername">ç”¨æˆ·å</label>
          <input type="text" id="loginUsername" name="loginUsername" placeholder="è¾“å…¥ç”¨æˆ·å" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">å¯†ç </label>
          <input type="password" id="loginPassword" name="loginPassword" placeholder="è¾“å…¥å¯†ç " required>
        </div>
        <button type="submit" id="loginBtn" class="login-btn">ç™»å½•</button>
      </form>
      
      <div id="loginResult" class="result"></div>
      
      <div id="userInfo" class="user-info">
        <h4>ğŸ‘¤ å½“å‰ç”¨æˆ·ä¿¡æ¯</h4>
        <p><strong>ç”¨æˆ·åï¼š</strong><span id="currentUsername"></span></p>
        <p><strong>åœ°å€ï¼š</strong><span id="currentAddress"></span></p>
        <button id="getBalanceBtn" class="login-btn" style="margin-bottom: 10px;">è·å–ä½™é¢</button>
        <button id="goToProjectBtn" class="project-btn">ğŸ“‹ é¡¹ç›®ç®¡ç†</button>
        <button id="logoutBtn" class="logout-btn">é€€å‡ºç™»å½•</button>
        <div id="balanceResult" class="result" style="margin-top: 10px;"></div>
      </div>
    </div>

    <!-- åˆ›å»ºè´¦æˆ·éƒ¨åˆ† -->
    <div class="form-section">
      <h3>â• åˆ›å»ºæ–°è´¦æˆ·</h3>
      <div class="warning">
        âš ï¸ <strong>å®‰å…¨æé†’ï¼š</strong> ç§é’¥æ˜¯è®¿é—®è´¦æˆ·çš„å”¯ä¸€å‡­è¯ï¼Œè¯·å¦¥å–„ä¿ç®¡ï¼
      </div>

      <form id="createAccountForm">
        <div class="form-group">
          <label for="username">ç”¨æˆ·å</label>
          <input type="text" id="username" name="username" placeholder="è¾“å…¥ç”¨æˆ·å" required>
        </div>
        <div class="form-group">
          <label for="password">å¯†ç </label>
          <input type="password" id="password" name="password" placeholder="è¾“å…¥å¯†ç " required>
        </div>
        <div class="form-group">
          <label for="confirmPassword">ç¡®è®¤å¯†ç </label>
          <input type="password" id="confirmPassword" name="confirmPassword" placeholder="å†æ¬¡è¾“å…¥å¯†ç " required>
        </div>
        <button type="submit" id="submitBtn">åˆ›å»ºè´¦æˆ·</button>
      </form>

      <div id="result" class="result"></div>
    </div>
  </div>

  <!-- åˆ›å»ºè´¦æˆ·æˆåŠŸå¼¹çª— -->
  <div id="accountModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>âœ… ä»¥å¤ªåŠè´¦æˆ·åˆ›å»ºæˆåŠŸï¼</h3>
      <div id="modalContent">
        <p><strong>ç”¨æˆ·åï¼š</strong><span id="modalUsername"></span></p>
        <p><strong>ä»¥å¤ªåŠåœ°å€ï¼š</strong></p>
        <div class="address" id="modalAddress"></div>
        <p><strong>ç§é’¥ï¼ˆè¯·å¦¥å–„ä¿ç®¡ï¼‰ï¼š</strong></p>
        <div class="private-key-hidden" id="modalPrivateKeyHidden">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ˜¾ç¤ºç§é’¥</div>
        <div class="private-key" id="modalPrivateKey" style="display: none;"></div>
        <button class="show-private-key" id="showPrivateKeyBtn">æ˜¾ç¤ºç§é’¥</button>
        <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong><span id="modalCreateTime"></span></p>
      </div>
    </div>
  </div>

  <script>
    // ç™»å½•è¡¨å•å¤„ç†
    document.getElementById('loginForm').onsubmit = async function (e) {
      e.preventDefault();

      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      const loginBtn = document.getElementById('loginBtn');
      const loginResult = document.getElementById('loginResult');

      // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      loginBtn.disabled = true;
      loginBtn.textContent = 'ç™»å½•ä¸­...';
      loginResult.style.display = 'none';

      try {
        // è°ƒç”¨ç™»å½•API
        const response = await fetch('api/accounts/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
          // ç™»å½•æˆåŠŸï¼Œå­˜å‚¨tokenå’Œç”¨æˆ·ä¿¡æ¯
          sessionStorage.setItem('token', data.data.token);
          sessionStorage.setItem('username', data.data.username);
          sessionStorage.setItem('address', data.data.address);
          
          // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
          document.getElementById('currentUsername').textContent = data.data.username;
          document.getElementById('currentAddress').textContent = data.data.address;
          document.getElementById('userInfo').style.display = 'block';
          document.getElementById('loginForm').style.display = 'none';
          
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          loginResult.className = 'result success';
          loginResult.innerHTML = '<h3>âœ… ç™»å½•æˆåŠŸï¼</h3><p>æ¬¢è¿å›æ¥ï¼Œ' + data.data.username + 'ï¼</p>';
          loginResult.style.display = 'block';
          
          // 3ç§’åéšè—æˆåŠŸæ¶ˆæ¯
          setTimeout(() => {
            loginResult.style.display = 'none';
          }, 3000);
        } else {
          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          loginResult.className = 'result error';
          loginResult.innerHTML = `<h3>âŒ ç™»å½•å¤±è´¥</h3><p>${data.message}</p>`;
          loginResult.style.display = 'block';
        }

      } catch (error) {
        console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error);
        loginResult.className = 'result error';
        loginResult.innerHTML = `
          <h3>âŒ ç½‘ç»œé”™è¯¯</h3>
          <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š</p>
          <ul>
            <li>æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ (http://localhost:5000)</li>
            <li>åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨</li>
            <li>ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
          </ul>
          <p><strong>é”™è¯¯è¯¦æƒ…ï¼š</strong> ${error.message}</p>
        `;
        loginResult.style.display = 'block';
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        loginBtn.disabled = false;
        loginBtn.textContent = 'ç™»å½•';
      }
    };

    // é€€å‡ºç™»å½•
    document.getElementById('logoutBtn').onclick = function() {
      sessionStorage.removeItem('token');
      sessionStorage.removeItem('username');
      document.getElementById('userInfo').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('loginForm').reset();
      document.getElementById('loginResult').style.display = 'none';
    };

    // åˆ›å»ºè´¦æˆ·è¡¨å•å¤„ç†
    document.getElementById('createAccountForm').onsubmit = async function (e) {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      const submitBtn = document.getElementById('submitBtn');
      const result = document.getElementById('result');

      // éªŒè¯å¯†ç 
      if (password !== confirmPassword) {
        result.className = 'result error';
        result.innerHTML = `
          <h3>âŒ å¯†ç ä¸åŒ¹é…</h3>
          <p>ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥</p>
        `;
        result.style.display = 'block';
        return;
      }

      // éªŒè¯å¯†ç é•¿åº¦
      if (password.length < 6) {
        result.className = 'result error';
        result.innerHTML = `
          <h3>âŒ å¯†ç å¤ªçŸ­</h3>
          <p>å¯†ç é•¿åº¦è‡³å°‘éœ€è¦6ä½å­—ç¬¦</p>
        `;
        result.style.display = 'block';
        return;
      }

      // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      submitBtn.disabled = true;
      submitBtn.textContent = 'åˆ›å»ºä¸­...';
      result.style.display = 'none';

      try {
        // è°ƒç”¨APIåˆ›å»ºè´¦æˆ·
        const response = await fetch('api/accounts/createAccount', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
          // æ˜¾ç¤ºå¼¹çª—
          document.getElementById('modalUsername').textContent = data.data.username;
          document.getElementById('modalAddress').textContent = data.data.address;
          document.getElementById('modalPrivateKey').textContent = data.data.privateKey;
          document.getElementById('modalCreateTime').textContent = new Date(data.data.createdAt).toLocaleString();
          
          // é‡ç½®ç§é’¥æ˜¾ç¤ºçŠ¶æ€
          document.getElementById('modalPrivateKey').style.display = 'none';
          document.getElementById('modalPrivateKeyHidden').style.display = 'block';
          document.getElementById('showPrivateKeyBtn').textContent = 'æ˜¾ç¤ºç§é’¥';
          
          // æ˜¾ç¤ºå¼¹çª—
          document.getElementById('accountModal').style.display = 'block';
          
          // æ¸…ç©ºè¡¨å•
          document.getElementById('createAccountForm').reset();
        } else {
          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          result.className = 'result error';
          result.innerHTML = `
            <h3>âŒ åˆ›å»ºå¤±è´¥</h3>
            <p>${data.message}</p>
          `;
          result.style.display = 'block';
        }

      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        result.className = 'result error';
        result.innerHTML = `
          <h3>âŒ ç½‘ç»œé”™è¯¯</h3>
          <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š</p>
          <ul>
            <li>æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ (http://localhost:5000)</li>
            <li>åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨</li>
            <li>ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
          </ul>
          <p><strong>é”™è¯¯è¯¦æƒ…ï¼š</strong> ${error.message}</p>
        `;
        result.style.display = 'block';
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitBtn.disabled = false;
        submitBtn.textContent = 'åˆ›å»ºè´¦æˆ·';
      }
    };

    // å¼¹çª—å…³é—­åŠŸèƒ½
    document.querySelector('.close').onclick = function() {
      document.getElementById('accountModal').style.display = 'none';
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
      const modal = document.getElementById('accountModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // æ˜¾ç¤º/éšè—ç§é’¥
    document.getElementById('showPrivateKeyBtn').onclick = function() {
      const privateKeyDiv = document.getElementById('modalPrivateKey');
      const privateKeyHiddenDiv = document.getElementById('modalPrivateKeyHidden');
      const btn = document.getElementById('showPrivateKeyBtn');
      
      if (privateKeyDiv.style.display === 'none') {
        privateKeyDiv.style.display = 'block';
        privateKeyHiddenDiv.style.display = 'none';
        btn.textContent = 'éšè—ç§é’¥';
      } else {
        privateKeyDiv.style.display = 'none';
        privateKeyHiddenDiv.style.display = 'block';
        btn.textContent = 'æ˜¾ç¤ºç§é’¥';
      }
    };

    // è·å–ä½™é¢
    document.getElementById('getBalanceBtn').onclick = async function() {
      const address = sessionStorage.getItem('address');
      const token = sessionStorage.getItem('token');
      
      if (!token) {
        const balanceResult = document.getElementById('balanceResult');
        balanceResult.className = 'result error';
        balanceResult.innerHTML = '<h3>âŒ æ²¡æœ‰ç™»å½•å‡­è¯</h3><p>è¯·å…ˆç™»å½•è·å–token</p>';
        balanceResult.style.display = 'block';
        return;
      }
      
      const balanceResult = document.getElementById('balanceResult');
      
      try {
        const response = await fetch(`api/accounts/getBalance`, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        const data = await response.json();
        console.log('ä½™é¢APIå“åº”:', data);
        
        if (data.success) {
          balanceResult.className = 'result success';
          balanceResult.innerHTML = `
            <h3>âœ… ä½™é¢è·å–æˆåŠŸï¼</h3>
            <p><strong>åœ°å€ï¼š</strong> ${address}</p>
            <p><strong>ä½™é¢ï¼š</strong> ${(Number(data.data.balance) / 1e18).toFixed(6)} ETH</p>
          `;
        } else {
          balanceResult.className = 'result error';
          balanceResult.innerHTML = `            <h3>âŒ è·å–ä½™é¢å¤±è´¥</h3>
            <p>${data.message}</p>
          `;
        }
        balanceResult.style.display = 'block';
      } catch (error) {
        console.error('è·å–ä½™é¢è¯·æ±‚å¤±è´¥:', error);
        balanceResult.className = 'result error';
        balanceResult.innerHTML = `
          <h3>âŒ ç½‘ç»œé”™è¯¯</h3>
          <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š</p>
          <ul>
            <li>æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ (http://localhost:5000)</li>
            <li>åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨</li>
            <li>ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
          </ul>
          <p><strong>é”™è¯¯è¯¦æƒ…ï¼š</strong> ${error.message}</p>
        `;
        balanceResult.style.display = 'block';
      }
    };

    // è·³è½¬åˆ°é¡¹ç›®ç®¡ç†é¡µé¢
    document.getElementById('goToProjectBtn').onclick = function() {
        window.location.href = 'project-management-test.html';
    };
  </script>
</body>

</html>
