<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>区块链账户管理</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 800px;
    }

    .container {
      display: flex;
      gap: 30px;
    }

    .form-section {
      flex: 1;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      width: 100%;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .login-btn {
      background-color: #28a745;
    }

    .login-btn:hover {
      background-color: #218838;
    }

    .result {
      margin-top: 20px;
      padding: 15px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 5px;
      display: none;
    }

    .success {
      background-color: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }

    .error {
      background-color: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }

    .address,
    .private-key {
      font-family: monospace;
      background-color: #e9ecef;
      padding: 8px;
      margin: 5px 0;
      border-radius: 3px;
      word-break: break-all;
    }

    .warning {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 5px;
      margin: 15px 0;
    }

    .user-info {
      background-color: #e7f3ff;
      border: 1px solid #b3d9ff;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      display: none;
    }

    .logout-btn {
      background-color: #dc3545;
      margin-top: 10px;
    }

    .logout-btn:hover {
      background-color: #c82333;
    }

    .project-btn {
      background-color: #17a2b8;
      margin-bottom: 10px;
    }

    .project-btn:hover {
      background-color: #138496;
    }

    /* 弹窗样式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      position: relative;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    .show-private-key {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }

    .show-private-key:hover {
      background-color: #c82333;
    }

    .private-key-hidden {
      color: #6c757d;
      font-style: italic;
    }
  </style>
</head>

<body>
  <h2>🔗 区块链账户管理</h2>

  <div class="container">
    <!-- 登录部分 -->
    <div class="form-section">
      <h3>🔐 用户登录</h3>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginUsername">用户名</label>
          <input type="text" id="loginUsername" name="loginUsername" placeholder="输入用户名" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">密码</label>
          <input type="password" id="loginPassword" name="loginPassword" placeholder="输入密码" required>
        </div>
        <button type="submit" id="loginBtn" class="login-btn">登录</button>
      </form>
      
      <div id="loginResult" class="result"></div>
      
      <div id="userInfo" class="user-info">
        <h4>👤 当前用户信息</h4>
        <p><strong>用户名：</strong><span id="currentUsername"></span></p>
        <p><strong>地址：</strong><span id="currentAddress"></span></p>
        <button id="getBalanceBtn" class="login-btn" style="margin-bottom: 10px;">获取余额</button>
        <button id="goToProjectBtn" class="project-btn">📋 项目管理</button>
        <button id="logoutBtn" class="logout-btn">退出登录</button>
        <div id="balanceResult" class="result" style="margin-top: 10px;"></div>
      </div>
    </div>

    <!-- 创建账户部分 -->
    <div class="form-section">
      <h3>➕ 创建新账户</h3>
      <div class="warning">
        ⚠️ <strong>安全提醒：</strong> 私钥是访问账户的唯一凭证，请妥善保管！
      </div>

      <form id="createAccountForm">
        <div class="form-group">
          <label for="username">用户名</label>
          <input type="text" id="username" name="username" placeholder="输入用户名" required>
        </div>
        <div class="form-group">
          <label for="password">密码</label>
          <input type="password" id="password" name="password" placeholder="输入密码" required>
        </div>
        <div class="form-group">
          <label for="confirmPassword">确认密码</label>
          <input type="password" id="confirmPassword" name="confirmPassword" placeholder="再次输入密码" required>
        </div>
        <button type="submit" id="submitBtn">创建账户</button>
      </form>

      <div id="result" class="result"></div>
    </div>
  </div>

  <!-- 创建账户成功弹窗 -->
  <div id="accountModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>✅ 以太坊账户创建成功！</h3>
      <div id="modalContent">
        <p><strong>用户名：</strong><span id="modalUsername"></span></p>
        <p><strong>以太坊地址：</strong></p>
        <div class="address" id="modalAddress"></div>
        <p><strong>私钥（请妥善保管）：</strong></p>
        <div class="private-key-hidden" id="modalPrivateKeyHidden">点击下方按钮显示私钥</div>
        <div class="private-key" id="modalPrivateKey" style="display: none;"></div>
        <button class="show-private-key" id="showPrivateKeyBtn">显示私钥</button>
        <p><strong>创建时间：</strong><span id="modalCreateTime"></span></p>
      </div>
    </div>
  </div>

  <script>
    // 登录表单处理
    document.getElementById('loginForm').onsubmit = async function (e) {
      e.preventDefault();

      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      const loginBtn = document.getElementById('loginBtn');
      const loginResult = document.getElementById('loginResult');

      // 禁用按钮并显示加载状态
      loginBtn.disabled = true;
      loginBtn.textContent = '登录中...';
      loginResult.style.display = 'none';

      try {
        // 调用登录API
        const response = await fetch('api/accounts/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
          // 登录成功，存储token和用户信息
          sessionStorage.setItem('token', data.data.token);
          sessionStorage.setItem('username', data.data.username);
          sessionStorage.setItem('address', data.data.address);
          
          // 显示用户信息
          document.getElementById('currentUsername').textContent = data.data.username;
          document.getElementById('currentAddress').textContent = data.data.address;
          document.getElementById('userInfo').style.display = 'block';
          document.getElementById('loginForm').style.display = 'none';
          
          // 显示成功消息
          loginResult.className = 'result success';
          loginResult.innerHTML = '<h3>✅ 登录成功！</h3><p>欢迎回来，' + data.data.username + '！</p>';
          loginResult.style.display = 'block';
          
          // 3秒后隐藏成功消息
          setTimeout(() => {
            loginResult.style.display = 'none';
          }, 3000);
        } else {
          // 显示错误信息
          loginResult.className = 'result error';
          loginResult.innerHTML = `<h3>❌ 登录失败</h3><p>${data.message}</p>`;
          loginResult.style.display = 'block';
        }

      } catch (error) {
        console.error('登录请求失败:', error);
        loginResult.className = 'result error';
        loginResult.innerHTML = `
          <h3>❌ 网络错误</h3>
          <p>无法连接到服务器，请检查：</p>
          <ul>
            <li>服务器是否正在运行 (http://localhost:5000)</li>
            <li>后端服务是否正常启动</li>
            <li>网络连接是否正常</li>
          </ul>
          <p><strong>错误详情：</strong> ${error.message}</p>
        `;
        loginResult.style.display = 'block';
      } finally {
        // 恢复按钮状态
        loginBtn.disabled = false;
        loginBtn.textContent = '登录';
      }
    };

    // 退出登录
    document.getElementById('logoutBtn').onclick = function() {
      sessionStorage.removeItem('token');
      sessionStorage.removeItem('username');
      document.getElementById('userInfo').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('loginForm').reset();
      document.getElementById('loginResult').style.display = 'none';
    };

    // 创建账户表单处理
    document.getElementById('createAccountForm').onsubmit = async function (e) {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      const submitBtn = document.getElementById('submitBtn');
      const result = document.getElementById('result');

      // 验证密码
      if (password !== confirmPassword) {
        result.className = 'result error';
        result.innerHTML = `
          <h3>❌ 密码不匹配</h3>
          <p>两次输入的密码不一致，请重新输入</p>
        `;
        result.style.display = 'block';
        return;
      }

      // 验证密码长度
      if (password.length < 6) {
        result.className = 'result error';
        result.innerHTML = `
          <h3>❌ 密码太短</h3>
          <p>密码长度至少需要6位字符</p>
        `;
        result.style.display = 'block';
        return;
      }

      // 禁用按钮并显示加载状态
      submitBtn.disabled = true;
      submitBtn.textContent = '创建中...';
      result.style.display = 'none';

      try {
        // 调用API创建账户
        const response = await fetch('api/accounts/createAccount', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
          // 显示弹窗
          document.getElementById('modalUsername').textContent = data.data.username;
          document.getElementById('modalAddress').textContent = data.data.address;
          document.getElementById('modalPrivateKey').textContent = data.data.privateKey;
          document.getElementById('modalCreateTime').textContent = new Date(data.data.createdAt).toLocaleString();
          
          // 重置私钥显示状态
          document.getElementById('modalPrivateKey').style.display = 'none';
          document.getElementById('modalPrivateKeyHidden').style.display = 'block';
          document.getElementById('showPrivateKeyBtn').textContent = '显示私钥';
          
          // 显示弹窗
          document.getElementById('accountModal').style.display = 'block';
          
          // 清空表单
          document.getElementById('createAccountForm').reset();
        } else {
          // 显示错误信息
          result.className = 'result error';
          result.innerHTML = `
            <h3>❌ 创建失败</h3>
            <p>${data.message}</p>
          `;
          result.style.display = 'block';
        }

      } catch (error) {
        console.error('请求失败:', error);
        result.className = 'result error';
        result.innerHTML = `
          <h3>❌ 网络错误</h3>
          <p>无法连接到服务器，请检查：</p>
          <ul>
            <li>服务器是否正在运行 (http://localhost:5000)</li>
            <li>后端服务是否正常启动</li>
            <li>网络连接是否正常</li>
          </ul>
          <p><strong>错误详情：</strong> ${error.message}</p>
        `;
        result.style.display = 'block';
      } finally {
        // 恢复按钮状态
        submitBtn.disabled = false;
        submitBtn.textContent = '创建账户';
      }
    };

    // 弹窗关闭功能
    document.querySelector('.close').onclick = function() {
      document.getElementById('accountModal').style.display = 'none';
    }

    // 点击弹窗外部关闭
    window.onclick = function(event) {
      const modal = document.getElementById('accountModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // 显示/隐藏私钥
    document.getElementById('showPrivateKeyBtn').onclick = function() {
      const privateKeyDiv = document.getElementById('modalPrivateKey');
      const privateKeyHiddenDiv = document.getElementById('modalPrivateKeyHidden');
      const btn = document.getElementById('showPrivateKeyBtn');
      
      if (privateKeyDiv.style.display === 'none') {
        privateKeyDiv.style.display = 'block';
        privateKeyHiddenDiv.style.display = 'none';
        btn.textContent = '隐藏私钥';
      } else {
        privateKeyDiv.style.display = 'none';
        privateKeyHiddenDiv.style.display = 'block';
        btn.textContent = '显示私钥';
      }
    };

    // 获取余额
    document.getElementById('getBalanceBtn').onclick = async function() {
      const address = sessionStorage.getItem('address');
      const token = sessionStorage.getItem('token');
      
      if (!token) {
        const balanceResult = document.getElementById('balanceResult');
        balanceResult.className = 'result error';
        balanceResult.innerHTML = '<h3>❌ 没有登录凭证</h3><p>请先登录获取token</p>';
        balanceResult.style.display = 'block';
        return;
      }
      
      const balanceResult = document.getElementById('balanceResult');
      
      try {
        const response = await fetch(`api/accounts/getBalance`, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        const data = await response.json();
        console.log('余额API响应:', data);
        
        if (data.success) {
          balanceResult.className = 'result success';
          balanceResult.innerHTML = `
            <h3>✅ 余额获取成功！</h3>
            <p><strong>地址：</strong> ${address}</p>
            <p><strong>余额：</strong> ${(Number(data.data.balance) / 1e18).toFixed(6)} ETH</p>
          `;
        } else {
          balanceResult.className = 'result error';
          balanceResult.innerHTML = `            <h3>❌ 获取余额失败</h3>
            <p>${data.message}</p>
          `;
        }
        balanceResult.style.display = 'block';
      } catch (error) {
        console.error('获取余额请求失败:', error);
        balanceResult.className = 'result error';
        balanceResult.innerHTML = `
          <h3>❌ 网络错误</h3>
          <p>无法连接到服务器，请检查：</p>
          <ul>
            <li>服务器是否正在运行 (http://localhost:5000)</li>
            <li>后端服务是否正常启动</li>
            <li>网络连接是否正常</li>
          </ul>
          <p><strong>错误详情：</strong> ${error.message}</p>
        `;
        balanceResult.style.display = 'block';
      }
    };

    // 跳转到项目管理页面
    document.getElementById('goToProjectBtn').onclick = function() {
        window.location.href = 'project-management-test.html';
    };
  </script>
</body>

</html>
