<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上传与评分测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .notification-section {
            background: #e8f4fd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .notification-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .notification-time {
            color: #666;
            font-size: 12px;
        }
        .notification-content {
            margin: 10px 0;
        }
        .score-btn {
            background: #28a745;
            padding: 5px 10px;
            font-size: 12px;
        }
        .score-btn:hover {
            background: #218838;
        }
        .score-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .score-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 60%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .score-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .score-slider {
            width: 100%;
            margin: 10px 0;
        }
        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            text-align: center;
            margin: 10px 0;
        }
        .close-btn {
            background: #6c757d;
        }
        .close-btn:hover {
            background: #545b62;
        }
        .contract-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.5;
        }
        .contract-info div {
            margin-bottom: 8px;
            word-break: break-all;
        }
        .contract-info strong {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
            display: block;
        }
        .refresh-btn {
            background: #17a2b8;
        }
        .refresh-btn:hover {
            background: #138496;
        }
        .no-notifications {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <h1>文件上传与评分测试</h1>
    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
        <h3 style="margin: 0 0 10px 0; color: #155724;">🔒 安全改进说明</h3>
        <p style="margin: 0; color: #155724;">
            <strong>密码验证机制：</strong>现在系统使用密码验证而不是直接输入私钥，提供更好的安全性。<br>
            • 文件上传时需要输入密码验证身份<br>
            • 评分时需要输入密码验证身份<br>
            • 私钥在服务器端通过密码解密，不会在前端暴露
        </p>
    </div>

    <div class="notification-section">
        <h2>通知管理</h2>
        <div class="form-group">
            <label>当前用户:</label>
            <input type="text" id="currentUser" readonly>
        </div>
        <button onclick="refreshNotifications()" class="refresh-btn">刷新通知</button>
        <div id="notificationsList"></div>
    </div>

    <div class="upload-section">
        <h2>单文件上传</h2>
        <div class="form-group">
            <label>子任务ID:</label>
            <input type="number" id="subtaskId" placeholder="输入子任务ID" value="1">
        </div>
        <div class="form-group">
            <label>描述:</label>
            <textarea id="description" placeholder="输入描述"></textarea>
        </div>
        <div class="form-group">
            <label>选择单个文件:</label>
            <input type="file" id="singleFile" accept="image/*,.pdf,.txt,application/zip,application/x-zip-compressed,.zip,application/x-rar-compressed,.rar">
        </div>
        <button onclick="uploadSingleFile()">上传单文件与描述</button>
        <div id="singleResult" class="result"></div>
    </div>

    <!-- 评分模态框 -->
    <div id="scoreModal" class="score-modal">
        <div class="score-modal-content">
            <h3>文件评分</h3>
            <div id="contractInfo" class="contract-info"></div>
            <div class="score-form">
                <label>评分 (1-10分):</label>
                <div class="score-value" id="scoreValue">5</div>
                <input type="range" id="scoreSlider" class="score-slider" min="1" max="10" value="5" oninput="updateScoreValue(this.value)">
                
                <label>密码:</label>
                <input type="password" id="passwordInput" placeholder="请输入您的密码以验证身份">
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeScoreModal()" class="close-btn">取消</button>
                    <button onclick="submitScore()" class="score-btn">提交评分</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // 页面加载时自动获取通知
        window.onload = function() {
            const username = sessionStorage.getItem('username');
            if (username) {
                document.getElementById('currentUser').value = username;
                loadNotifications();
            } else {
                document.getElementById('currentUser').value = '未登录';
                document.getElementById('notificationsList').innerHTML = '<div class="no-notifications">请先登录</div>';
            }
        };

        // 获取通知列表
        async function loadNotifications() {
            const username = sessionStorage.getItem('username');
            const notificationsList = document.getElementById('notificationsList');
            
            if (!username) {
                notificationsList.innerHTML = '<div class="no-notifications">请先登录</div>';
                return;
            }

            try {
                notificationsList.innerHTML = '<div class="no-notifications">加载中...</div>';
                
                const response = await fetch(`/api/notifications/getNotificationList/${username}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                    }
                });

                const notifications = await response.json();
                
                if (notifications.length === 0) {
                    notificationsList.innerHTML = '<div class="no-notifications">暂无未读通知</div>';
                } else {
                    displayNotifications(notifications);
                }
            } catch (error) {
                notificationsList.innerHTML = '<div class="no-notifications">获取通知失败: ' + error.message + '</div>';
            }
        }

        // 显示通知列表
        function displayNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');
            let html = '';
            
            notifications.forEach(notification => {
                const time = new Date(notification.createdTime).toLocaleString('zh-CN');
                let content = '';
                
                if (notification.type === 'file') {
                    try {
                        const fileContent = JSON.parse(notification.content);
                        content = `
                            <div><strong>文件上传通知</strong></div>
                            <div>文件名: ${fileContent.fileName || '未知'}</div>
                            <div>文件大小: ${fileContent.fileSize || '未知'} bytes</div>
                            <div>文件类型: ${fileContent.fileType || '未知'}</div>
                            <div>所属子任务: ${fileContent.subtaskId || '未知'}</div>
                            <div>上传时间: ${fileContent.uploadTime ? new Date(fileContent.uploadTime).toLocaleString('zh-CN') : '未知'}</div>
                            <div>合约地址: ${fileContent.contractAddress || '未知'}</div>
                        `;
                    } catch (error) {
                        content = `<div><strong>文件上传通知</strong></div><div>内容解析失败: ${error.message}</div>`;
                    }
                } else {
                    content = `<div>${notification.content || '未知类型通知'}</div>`;
                }
                
                // 只有文件通知才显示评分按钮
                let scoreButton;
                if (notification.type === 'file') {
                    try {
                        const fileContent = JSON.parse(notification.content);
                        if (fileContent.contractAddress && fileContent.contractAddress !== 'undefined') {
                            scoreButton = `<button onclick="goToScore('${fileContent.contractAddress}', ${notification.id})" class="score-btn">前往评分</button>`;
                        } else {
                            scoreButton = `<button onclick="markAsRead(${notification.id})" class="score-btn">标记已读</button>`;
                        }
                    } catch (error) {
                        scoreButton = `<button onclick="markAsRead(${notification.id})" class="score-btn">标记已读</button>`;
                    }
                } else {
                    scoreButton = `<button onclick="markAsRead(${notification.id})" class="score-btn">标记已读</button>`;
                }
                
                html += `
                    <div class="notification-item" data-id="${notification.id}">
                        <div class="notification-header">
                            <div>
                                <strong>来自: ${notification.sender}</strong>
                                <div class="notification-time">${time}</div>
                            </div>
                            ${scoreButton}
                        </div>
                        <div class="notification-content" data-content='${notification.content || ''}'>
                            ${content}
                        </div>
                    </div>
                `;
            });
            
            notificationsList.innerHTML = html;
        }

        // 标记通知为已读
        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/markAsRead/${notificationId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    // 从DOM中移除该通知项
                    const notificationItem = document.querySelector(`[data-id="${notificationId}"]`);
                    if (notificationItem) {
                        notificationItem.remove();
                    }
                    
                    // 检查是否还有其他通知
                    const remainingNotifications = document.querySelectorAll('.notification-item');
                    if (remainingNotifications.length === 0) {
                        document.getElementById('notificationsList').innerHTML = '<div class="no-notifications">暂无未读通知</div>';
                    }
                } else {
                    alert('标记已读失败: ' + result.error);
                }
            } catch (error) {
                alert('标记已读失败: ' + error.message);
            }
        }

        // 刷新通知
        function refreshNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '';
            loadNotifications();
        }

        // 全局变量保存当前评分的合约地址和通知ID
        let currentContractAddress = '';
        let currentNotificationId = '';
        let currentSubtaskId = '';

        // 前往评分页面
        async function goToScore(contractAddress, notificationId) {
            if (!contractAddress || contractAddress === 'undefined') {
                alert('合约地址无效');
                return;
            }

            currentContractAddress = contractAddress;
            currentNotificationId = notificationId;
            
            // 从通知内容中获取 subtaskId
            try {
                const notificationElement = document.querySelector(`[data-id="${notificationId}"]`);
                if (notificationElement) {
                    const contentElement = notificationElement.querySelector('.notification-content');
                    const contentData = contentElement.getAttribute('data-content');
                    
                    if (contentData) {
                        const fileContent = JSON.parse(contentData);
                        currentSubtaskId = fileContent.subtaskId || '';
                    } else {
                        console.error('通知内容为空');
                        currentSubtaskId = '';
                    }
                } else {
                    console.error('找不到通知元素:', notificationId);
                    currentSubtaskId = '';
                }
            } catch (error) {
                console.error('获取subtaskId失败:', error);
                currentSubtaskId = '';
            }
            
            try {

                // 获取合约信息
                const contractResponse = await fetch(`/api/score/contract/${contractAddress}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                    }
                });

                if (!contractResponse.ok) {
                    const errorText = await contractResponse.text();
                    console.error('获取合约信息响应错误:', contractResponse.status, errorText);
                    alert('获取合约信息失败: HTTP ' + contractResponse.status + '\n' + errorText);
                    return;
                }

                const contractResult = await contractResponse.json();
                
                if (contractResult.success) {
                    displayContractInfo(contractResult.data);
                    openScoreModal();
                } else {
                    alert('获取合约信息失败: ' + contractResult.message);
                }
                
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        // 显示合约信息
        function displayContractInfo(contractData) {
            const contractInfo = document.getElementById('contractInfo');
            const deadline = new Date(contractData.subtaskEndtime * 1000);
            const now = new Date();
            const isExpired = now > deadline;
            
            contractInfo.innerHTML = `
                <strong>📋 合约信息</strong>
                <div><strong>👤 贡献者:</strong><br>${contractData.contributor}</div>
                <div><strong>🔗 贡献哈希:</strong><br>${contractData.contributionHash}</div>
                <div><strong>⚖️ 权重:</strong> ${contractData.weight}</div>
                <div><strong>⭐ 当前平均分:</strong> ${contractData.averageScore}/10</div>
                <div><strong>👥 评分人数:</strong> ${contractData.scoreCount}</div>
                <div><strong>🎯 贡献点数:</strong> ${contractData.contributionPoints}</div>
                <div><strong>⏱️ 时间因子:</strong> ${contractData.timeFactor}/1000</div>
                <div><strong>📅 截止时间:</strong> ${deadline.toLocaleString('zh-CN')} ${isExpired ? '(已过期)' : ''}</div>
            `;
        }

        // 打开评分模态框
        function openScoreModal() {
            document.getElementById('scoreModal').style.display = 'block';
            // 重置表单
            document.getElementById('scoreSlider').value = 5;
            document.getElementById('scoreValue').textContent = '5';
            document.getElementById('passwordInput').value = '';
        }

        // 关闭评分模态框
        function closeScoreModal() {
            document.getElementById('scoreModal').style.display = 'none';
        }

        // 更新评分显示值
        function updateScoreValue(value) {
            document.getElementById('scoreValue').textContent = value;
        }

        // 提交评分
        async function submitScore() {
            const score = parseInt(document.getElementById('scoreSlider').value);
            const password = document.getElementById('passwordInput').value.trim();

            if (!password) {
                alert('请输入密码以验证身份');
                return;
            }

            if (score < 1 || score > 10) {
                alert('评分必须在1-10之间');
                return;
            }

            try {
                const response = await fetch('/api/score/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                    },
                    body: JSON.stringify({
                        contractAddress: currentContractAddress,
                        score: score,
                        password: password,
                        subtaskId: currentSubtaskId
                    })
                });

                if (response.status === 400) {
                    const errorText = await response.text();
                    alert('评分失败: ' + errorText);
                    return;
                }

                const result = await response.json();
                
                if (result.success) {
                    alert('评分成功！\n交易哈希: ' + result.data.transactionHash);
                    // 标记通知为已读
                    if (currentNotificationId) {
                        markAsRead(currentNotificationId);
                    }
                    let isAllRead = await checkAllScored();
                    if (isAllRead) {
                        updateContributionPoint();
                    }
                    closeScoreModal();
                    // 刷新通知列表
                    refreshNotifications();
                } else {
                    alert('评分失败: ' + result.message);
                }
            } catch (error) {
                alert('评分失败: ' + error.message);
            }
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('scoreModal');
            if (event.target === modal) {
                closeScoreModal();
            }
        }

        // 单文件上传
        async function uploadSingleFile() {
            const fileInput = document.getElementById('singleFile');
            const resultDiv = document.getElementById('singleResult');
            const descriptionInput = document.getElementById('description');
            const subtaskIdInput = document.getElementById('subtaskId');
            
            if (fileInput.files.length === 0) {
                resultDiv.textContent = '请选择文件';
                return;
            }
            if (!descriptionInput.value.trim()) {
                resultDiv.textContent = '请填写描述';
                return;
            }

            // 弹出密码输入框（用于验证身份和解密私钥）
            const password = prompt('请输入您的密码以验证身份:');
            if (!password || password.trim() === '') {
                resultDiv.textContent = '请输入密码';
                return;
            }

            const formData = new FormData();
            formData.append('files', fileInput.files[0]);

            formData.append('description', descriptionInput.value.trim());
            formData.append('subtaskId', subtaskIdInput.value);
            formData.append('password', password.trim());

            console.log(formData.get('files'));
            
            try {
                resultDiv.textContent = '上传中...';
                
                const response = await fetch('/api/files/filesUpload', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                    }
                });

                const result = await response.json();
                resultDiv.textContent = JSON.stringify(result, null, 2);
                
                if (result.success) {
                    fileInput.value = ''; // 清空文件选择
                    descriptionInput.value = '';
                    // 上传成功后刷新通知
                    setTimeout(() => {
                        refreshNotifications();
                    }, 1000);
                }
            } catch (error) {
                resultDiv.textContent = '上传失败: ' + error.message;
            }
        }

        // 检查是否全部评分
        async function checkAllScored() {
            const response = await fetch(`/api/notifications/isAllRead/${currentSubtaskId}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                }
            });
            const result = await response.json();
            return result.data;
        }

        // 更新贡献点
        async function updateContributionPoint() {
            const response = await fetch(`/api/score/updateContributionPoint/${currentContractAddress}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                }
            });
            const result = await response.json();
            if (result.success) {
                console.log('贡献点更新成功');
            } else {
                console.log('贡献点更新失败');
            }
        }

    </script>
</body>
</html> 