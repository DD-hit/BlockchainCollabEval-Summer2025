<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ ä¸è¯„åˆ†æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .notification-section {
            background: #e8f4fd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .notification-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .notification-time {
            color: #666;
            font-size: 12px;
        }
        .notification-content {
            margin: 10px 0;
        }
        .score-btn {
            background: #28a745;
            padding: 5px 10px;
            font-size: 12px;
        }
        .score-btn:hover {
            background: #218838;
        }
        .score-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .score-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 60%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .score-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .score-slider {
            width: 100%;
            margin: 10px 0;
        }
        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            text-align: center;
            margin: 10px 0;
        }
        .close-btn {
            background: #6c757d;
        }
        .close-btn:hover {
            background: #545b62;
        }
        .contract-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.5;
        }
        .contract-info div {
            margin-bottom: 8px;
            word-break: break-all;
        }
        .contract-info strong {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
            display: block;
        }
        .refresh-btn {
            background: #17a2b8;
        }
        .refresh-btn:hover {
            background: #138496;
        }
        .no-notifications {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <h1>æ–‡ä»¶ä¸Šä¼ ä¸è¯„åˆ†æµ‹è¯•</h1>
    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
        <h3 style="margin: 0 0 10px 0; color: #155724;">ğŸ”’ å®‰å…¨æ”¹è¿›è¯´æ˜</h3>
        <p style="margin: 0; color: #155724;">
            <strong>å¯†ç éªŒè¯æœºåˆ¶ï¼š</strong>ç°åœ¨ç³»ç»Ÿä½¿ç”¨å¯†ç éªŒè¯è€Œä¸æ˜¯ç›´æ¥è¾“å…¥ç§é’¥ï¼Œæä¾›æ›´å¥½çš„å®‰å…¨æ€§ã€‚<br>
            â€¢ æ–‡ä»¶ä¸Šä¼ æ—¶éœ€è¦è¾“å…¥å¯†ç éªŒè¯èº«ä»½<br>
            â€¢ è¯„åˆ†æ—¶éœ€è¦è¾“å…¥å¯†ç éªŒè¯èº«ä»½<br>
            â€¢ ç§é’¥åœ¨æœåŠ¡å™¨ç«¯é€šè¿‡å¯†ç è§£å¯†ï¼Œä¸ä¼šåœ¨å‰ç«¯æš´éœ²
        </p>
    </div>

    <div class="notification-section">
        <h2>é€šçŸ¥ç®¡ç†</h2>
        <div class="form-group">
            <label>å½“å‰ç”¨æˆ·:</label>
            <input type="text" id="currentUser" readonly>
        </div>
        <button onclick="refreshNotifications()" class="refresh-btn">åˆ·æ–°é€šçŸ¥</button>
        <div id="notificationsList"></div>
    </div>

    <div class="upload-section">
        <h2>å•æ–‡ä»¶ä¸Šä¼ </h2>
        <div class="form-group">
            <label>å­ä»»åŠ¡ID:</label>
            <input type="number" id="subtaskId" placeholder="è¾“å…¥å­ä»»åŠ¡ID" value="1">
        </div>
        <div class="form-group">
            <label>æè¿°:</label>
            <textarea id="description" placeholder="è¾“å…¥æè¿°"></textarea>
        </div>
        <div class="form-group">
            <label>é€‰æ‹©å•ä¸ªæ–‡ä»¶:</label>
            <input type="file" id="singleFile" accept="image/*,.pdf,.txt,application/zip,application/x-zip-compressed,.zip,application/x-rar-compressed,.rar">
        </div>
        <button onclick="uploadSingleFile()">ä¸Šä¼ å•æ–‡ä»¶ä¸æè¿°</button>
        <div id="singleResult" class="result"></div>
    </div>

    <!-- è¯„åˆ†æ¨¡æ€æ¡† -->
    <div id="scoreModal" class="score-modal">
        <div class="score-modal-content">
            <h3>æ–‡ä»¶è¯„åˆ†</h3>
            <div id="contractInfo" class="contract-info"></div>
            <div class="score-form">
                <label>è¯„åˆ† (1-10åˆ†):</label>
                <div class="score-value" id="scoreValue">5</div>
                <input type="range" id="scoreSlider" class="score-slider" min="1" max="10" value="5" oninput="updateScoreValue(this.value)">
                
                <label>å¯†ç :</label>
                <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥æ‚¨çš„å¯†ç ä»¥éªŒè¯èº«ä»½">
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeScoreModal()" class="close-btn">å–æ¶ˆ</button>
                    <button onclick="submitScore()" class="score-btn">æäº¤è¯„åˆ†</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–é€šçŸ¥
        window.onload = function() {
            const username = sessionStorage.getItem('username');
            if (username) {
                document.getElementById('currentUser').value = username;
                loadNotifications();
            } else {
                document.getElementById('currentUser').value = 'æœªç™»å½•';
                document.getElementById('notificationsList').innerHTML = '<div class="no-notifications">è¯·å…ˆç™»å½•</div>';
            }
        };

        // è·å–é€šçŸ¥åˆ—è¡¨
        async function loadNotifications() {
            const username = sessionStorage.getItem('username');
            const notificationsList = document.getElementById('notificationsList');
            
            if (!username) {
                notificationsList.innerHTML = '<div class="no-notifications">è¯·å…ˆç™»å½•</div>';
                return;
            }

            try {
                notificationsList.innerHTML = '<div class="no-notifications">åŠ è½½ä¸­...</div>';
                
                const response = await fetch(`/api/notifications/getNotificationList/${username}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                    }
                });

                const notifications = await response.json();
                
                if (notifications.length === 0) {
                    notificationsList.innerHTML = '<div class="no-notifications">æš‚æ— æœªè¯»é€šçŸ¥</div>';
                } else {
                    displayNotifications(notifications);
                }
            } catch (error) {
                notificationsList.innerHTML = '<div class="no-notifications">è·å–é€šçŸ¥å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥åˆ—è¡¨
        function displayNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');
            let html = '';
            
            notifications.forEach(notification => {
                const time = new Date(notification.createdTime).toLocaleString('zh-CN');
                let content = '';
                
                if (notification.type === 'file') {
                    try {
                        const fileContent = JSON.parse(notification.content);
                        content = `
                            <div><strong>æ–‡ä»¶ä¸Šä¼ é€šçŸ¥</strong></div>
                            <div>æ–‡ä»¶å: ${fileContent.fileName || 'æœªçŸ¥'}</div>
                            <div>æ–‡ä»¶å¤§å°: ${fileContent.fileSize || 'æœªçŸ¥'} bytes</div>
                            <div>æ–‡ä»¶ç±»å‹: ${fileContent.fileType || 'æœªçŸ¥'}</div>
                            <div>æ‰€å±å­ä»»åŠ¡: ${fileContent.subtaskId || 'æœªçŸ¥'}</div>
                            <div>ä¸Šä¼ æ—¶é—´: ${fileContent.uploadTime ? new Date(fileContent.uploadTime).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
                            <div>åˆçº¦åœ°å€: ${fileContent.contractAddress || 'æœªçŸ¥'}</div>
                        `;
                    } catch (error) {
                        content = `<div><strong>æ–‡ä»¶ä¸Šä¼ é€šçŸ¥</strong></div><div>å†…å®¹è§£æå¤±è´¥: ${error.message}</div>`;
                    }
                } else {
                    content = `<div>${notification.content || 'æœªçŸ¥ç±»å‹é€šçŸ¥'}</div>`;
                }
                
                // åªæœ‰æ–‡ä»¶é€šçŸ¥æ‰æ˜¾ç¤ºè¯„åˆ†æŒ‰é’®
                let scoreButton;
                if (notification.type === 'file') {
                    try {
                        const fileContent = JSON.parse(notification.content);
                        if (fileContent.contractAddress && fileContent.contractAddress !== 'undefined') {
                            scoreButton = `<button onclick="goToScore('${fileContent.contractAddress}', ${notification.id})" class="score-btn">å‰å¾€è¯„åˆ†</button>`;
                        } else {
                            scoreButton = `<button onclick="markAsRead(${notification.id})" class="score-btn">æ ‡è®°å·²è¯»</button>`;
                        }
                    } catch (error) {
                        scoreButton = `<button onclick="markAsRead(${notification.id})" class="score-btn">æ ‡è®°å·²è¯»</button>`;
                    }
                } else {
                    scoreButton = `<button onclick="markAsRead(${notification.id})" class="score-btn">æ ‡è®°å·²è¯»</button>`;
                }
                
                html += `
                    <div class="notification-item" data-id="${notification.id}">
                        <div class="notification-header">
                            <div>
                                <strong>æ¥è‡ª: ${notification.sender}</strong>
                                <div class="notification-time">${time}</div>
                            </div>
                            ${scoreButton}
                        </div>
                        <div class="notification-content" data-content='${notification.content || ''}'>
                            ${content}
                        </div>
                    </div>
                `;
            });
            
            notificationsList.innerHTML = html;
        }

        // æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/markAsRead/${notificationId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    // ä»DOMä¸­ç§»é™¤è¯¥é€šçŸ¥é¡¹
                    const notificationItem = document.querySelector(`[data-id="${notificationId}"]`);
                    if (notificationItem) {
                        notificationItem.remove();
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–é€šçŸ¥
                    const remainingNotifications = document.querySelectorAll('.notification-item');
                    if (remainingNotifications.length === 0) {
                        document.getElementById('notificationsList').innerHTML = '<div class="no-notifications">æš‚æ— æœªè¯»é€šçŸ¥</div>';
                    }
                } else {
                    alert('æ ‡è®°å·²è¯»å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('æ ‡è®°å·²è¯»å¤±è´¥: ' + error.message);
            }
        }

        // åˆ·æ–°é€šçŸ¥
        function refreshNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '';
            loadNotifications();
        }

        // å…¨å±€å˜é‡ä¿å­˜å½“å‰è¯„åˆ†çš„åˆçº¦åœ°å€å’Œé€šçŸ¥ID
        let currentContractAddress = '';
        let currentNotificationId = '';
        let currentSubtaskId = '';

        // å‰å¾€è¯„åˆ†é¡µé¢
        async function goToScore(contractAddress, notificationId) {
            if (!contractAddress || contractAddress === 'undefined') {
                alert('åˆçº¦åœ°å€æ— æ•ˆ');
                return;
            }

            currentContractAddress = contractAddress;
            currentNotificationId = notificationId;
            
            // ä»é€šçŸ¥å†…å®¹ä¸­è·å– subtaskId
            try {
                const notificationElement = document.querySelector(`[data-id="${notificationId}"]`);
                if (notificationElement) {
                    const contentElement = notificationElement.querySelector('.notification-content');
                    const contentData = contentElement.getAttribute('data-content');
                    
                    if (contentData) {
                        const fileContent = JSON.parse(contentData);
                        currentSubtaskId = fileContent.subtaskId || '';
                    } else {
                        console.error('é€šçŸ¥å†…å®¹ä¸ºç©º');
                        currentSubtaskId = '';
                    }
                } else {
                    console.error('æ‰¾ä¸åˆ°é€šçŸ¥å…ƒç´ :', notificationId);
                    currentSubtaskId = '';
                }
            } catch (error) {
                console.error('è·å–subtaskIdå¤±è´¥:', error);
                currentSubtaskId = '';
            }
            
            try {

                // è·å–åˆçº¦ä¿¡æ¯
                const contractResponse = await fetch(`/api/score/contract/${contractAddress}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                    }
                });

                if (!contractResponse.ok) {
                    const errorText = await contractResponse.text();
                    console.error('è·å–åˆçº¦ä¿¡æ¯å“åº”é”™è¯¯:', contractResponse.status, errorText);
                    alert('è·å–åˆçº¦ä¿¡æ¯å¤±è´¥: HTTP ' + contractResponse.status + '\n' + errorText);
                    return;
                }

                const contractResult = await contractResponse.json();
                
                if (contractResult.success) {
                    displayContractInfo(contractResult.data);
                    openScoreModal();
                } else {
                    alert('è·å–åˆçº¦ä¿¡æ¯å¤±è´¥: ' + contractResult.message);
                }
                
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºåˆçº¦ä¿¡æ¯
        function displayContractInfo(contractData) {
            const contractInfo = document.getElementById('contractInfo');
            const deadline = new Date(contractData.subtaskEndtime * 1000);
            const now = new Date();
            const isExpired = now > deadline;
            
            contractInfo.innerHTML = `
                <strong>ğŸ“‹ åˆçº¦ä¿¡æ¯</strong>
                <div><strong>ğŸ‘¤ è´¡çŒ®è€…:</strong><br>${contractData.contributor}</div>
                <div><strong>ğŸ”— è´¡çŒ®å“ˆå¸Œ:</strong><br>${contractData.contributionHash}</div>
                <div><strong>âš–ï¸ æƒé‡:</strong> ${contractData.weight}</div>
                <div><strong>â­ å½“å‰å¹³å‡åˆ†:</strong> ${contractData.averageScore}/10</div>
                <div><strong>ğŸ‘¥ è¯„åˆ†äººæ•°:</strong> ${contractData.scoreCount}</div>
                <div><strong>ğŸ¯ è´¡çŒ®ç‚¹æ•°:</strong> ${contractData.contributionPoints}</div>
                <div><strong>â±ï¸ æ—¶é—´å› å­:</strong> ${contractData.timeFactor}/1000</div>
                <div><strong>ğŸ“… æˆªæ­¢æ—¶é—´:</strong> ${deadline.toLocaleString('zh-CN')} ${isExpired ? '(å·²è¿‡æœŸ)' : ''}</div>
            `;
        }

        // æ‰“å¼€è¯„åˆ†æ¨¡æ€æ¡†
        function openScoreModal() {
            document.getElementById('scoreModal').style.display = 'block';
            // é‡ç½®è¡¨å•
            document.getElementById('scoreSlider').value = 5;
            document.getElementById('scoreValue').textContent = '5';
            document.getElementById('passwordInput').value = '';
        }

        // å…³é—­è¯„åˆ†æ¨¡æ€æ¡†
        function closeScoreModal() {
            document.getElementById('scoreModal').style.display = 'none';
        }

        // æ›´æ–°è¯„åˆ†æ˜¾ç¤ºå€¼
        function updateScoreValue(value) {
            document.getElementById('scoreValue').textContent = value;
        }

        // æäº¤è¯„åˆ†
        async function submitScore() {
            const score = parseInt(document.getElementById('scoreSlider').value);
            const password = document.getElementById('passwordInput').value.trim();

            if (!password) {
                alert('è¯·è¾“å…¥å¯†ç ä»¥éªŒè¯èº«ä»½');
                return;
            }

            if (score < 1 || score > 10) {
                alert('è¯„åˆ†å¿…é¡»åœ¨1-10ä¹‹é—´');
                return;
            }

            try {
                const response = await fetch('/api/score/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                    },
                    body: JSON.stringify({
                        contractAddress: currentContractAddress,
                        score: score,
                        password: password,
                        subtaskId: currentSubtaskId
                    })
                });

                if (response.status === 400) {
                    const errorText = await response.text();
                    alert('è¯„åˆ†å¤±è´¥: ' + errorText);
                    return;
                }

                const result = await response.json();
                
                if (result.success) {
                    alert('è¯„åˆ†æˆåŠŸï¼\näº¤æ˜“å“ˆå¸Œ: ' + result.data.transactionHash);
                    // æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
                    if (currentNotificationId) {
                        markAsRead(currentNotificationId);
                    }
                    let isAllRead = await checkAllScored();
                    if (isAllRead) {
                        updateContributionPoint();
                    }
                    closeScoreModal();
                    // åˆ·æ–°é€šçŸ¥åˆ—è¡¨
                    refreshNotifications();
                } else {
                    alert('è¯„åˆ†å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è¯„åˆ†å¤±è´¥: ' + error.message);
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('scoreModal');
            if (event.target === modal) {
                closeScoreModal();
            }
        }

        // å•æ–‡ä»¶ä¸Šä¼ 
        async function uploadSingleFile() {
            const fileInput = document.getElementById('singleFile');
            const resultDiv = document.getElementById('singleResult');
            const descriptionInput = document.getElementById('description');
            const subtaskIdInput = document.getElementById('subtaskId');
            
            if (fileInput.files.length === 0) {
                resultDiv.textContent = 'è¯·é€‰æ‹©æ–‡ä»¶';
                return;
            }
            if (!descriptionInput.value.trim()) {
                resultDiv.textContent = 'è¯·å¡«å†™æè¿°';
                return;
            }

            // å¼¹å‡ºå¯†ç è¾“å…¥æ¡†ï¼ˆç”¨äºéªŒè¯èº«ä»½å’Œè§£å¯†ç§é’¥ï¼‰
            const password = prompt('è¯·è¾“å…¥æ‚¨çš„å¯†ç ä»¥éªŒè¯èº«ä»½:');
            if (!password || password.trim() === '') {
                resultDiv.textContent = 'è¯·è¾“å…¥å¯†ç ';
                return;
            }

            const formData = new FormData();
            formData.append('files', fileInput.files[0]);

            formData.append('description', descriptionInput.value.trim());
            formData.append('subtaskId', subtaskIdInput.value);
            formData.append('password', password.trim());

            console.log(formData.get('files'));
            
            try {
                resultDiv.textContent = 'ä¸Šä¼ ä¸­...';
                
                const response = await fetch('/api/files/filesUpload', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                    }
                });

                const result = await response.json();
                resultDiv.textContent = JSON.stringify(result, null, 2);
                
                if (result.success) {
                    fileInput.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    descriptionInput.value = '';
                    // ä¸Šä¼ æˆåŠŸååˆ·æ–°é€šçŸ¥
                    setTimeout(() => {
                        refreshNotifications();
                    }, 1000);
                }
            } catch (error) {
                resultDiv.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
            }
        }

        // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨è¯„åˆ†
        async function checkAllScored() {
            const response = await fetch(`/api/notifications/isAllRead/${currentSubtaskId}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                }
            });
            const result = await response.json();
            return result.data;
        }

        // æ›´æ–°è´¡çŒ®ç‚¹
        async function updateContributionPoint() {
            const response = await fetch(`/api/score/updateContributionPoint/${currentContractAddress}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                }
            });
            const result = await response.json();
            if (result.success) {
                console.log('è´¡çŒ®ç‚¹æ›´æ–°æˆåŠŸ');
            } else {
                console.log('è´¡çŒ®ç‚¹æ›´æ–°å¤±è´¥');
            }
        }

    </script>
</body>
</html> 